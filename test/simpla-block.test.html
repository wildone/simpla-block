<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>simpla-block</title>
    <script src="../../webcomponentsjs/webcomponents.min.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../test-fixture/test-fixture-mocha.js"></script>
    <link rel="import" href="../../test-fixture/test-fixture.html">

    <!-- Import the element to test -->
    <link rel="import" href="../simpla-block.html">

    <!-- Define mock child -->
    <script>
      Polymer({
        is: 'mock-namespace-child',
        properties: {
          uid: {
            type: String,
            value: ''
          }
        },
        behaviors: [ simpla.behaviors.blockNamespaceChild ]
      });
    </script>
  </head>
  <body>
    <test-fixture id="default">
      <template>
        <simpla-block sid="foo">
          <mock-namespace-child sid="bar" data-expected-uid="foo.bar"></mock-namespace-child>

          <simpla-block sid="baz">
            <mock-namespace-child sid="qux" data-expected-uid="foo.baz.qux"></mock-namespace-child>
            <mock-namespace-child sid="bar" data-expected-uid="foo.baz.bar"></mock-namespace-child>
          </simpla-block>

          <!-- Check for escaping of special characters -->
          <simpla-block sid="baz.com">
            <mock-namespace-child sid="qux" data-expected-uid="foo.baz\.com.qux"></mock-namespace-child>
          </simpla-block>
        </simpla-block>
      </template>
    </test-fixture>

    <test-fixture id="dynamic-uid">
      <template>
        <simpla-block sid="foo">
          <mock-namespace-child sid="bar"></mock-namespace-child>
          <simpla-block sid="baz">
            <mock-namespace-child sid="qux"></mock-namespace-child>
          </simpla-block>
        </simpla-block>
      </template>
    </test-fixture>
    <script>
      describe('<simpla-block>', function() {

        var component;

        beforeEach(function() {
          component = fixture('default');
        });

        it('is okay', function() {
          expect(component).to.be.ok;
        });

        describe('uid composure', function() {
          it('should compose uids as expected, including escaping', function() {
            [].slice.call(component.querySelectorAll('mock-namespace-child'))
              .forEach(function(mock) {
                var uid = mock.uid,
                    expected = mock.getAttribute('data-expected-uid');

                expect(uid).to.equal(expected);
              });
          });

          it('should be able to change uid of a namespace and notify it\'s children', function() {
            var root = fixture('dynamic-uid');

            root.sid = 'bar';
            expect(root.querySelector('[sid="bar"]').uid).to.equal('bar.bar');
            expect(root.querySelector('[sid="qux"]').uid).to.equal('bar.baz.qux');
          });
        });
      });
    </script>
  </body>
</html>
